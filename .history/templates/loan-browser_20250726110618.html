<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Dashboard</title>
    <link rel="stylesheet" href="/assets/css/loan-browser.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Loan Dashboard</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#apply-loan" class="nav-link active">Apply for Loan</a></li>
                    <li><a href="#view-loan" class="nav-link">View Loan</a></li>
                    <li><a href="#view-products" class="nav-link">View Products</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="user-info">
                    <span class="user-name">{{ username }}</span>
                    <span class="user-role">{{ role | capitalize }}</span>
                </div>
                <div class="user-menu">
                    <a href="{{ url_for('loan_profiles') }}">My Profile</a>
                    <a href="{{ url_for('logout') }}">Log Out</a>
                </div>
            </header>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <h2>Welcome Dashboard</h2>
                <p>Hello, {{ username }}!</p>
            </section>

            <!-- Add Loan Section -->
            <section id="apply-loan" class="content-section">
                <div class="breadcrumb">
                    <a href="#dashboard">Dashboard</a> > <span>Add Loan</span>
                </div>
                <div class="card">
                    <h3>Loan Application</h3>
                    <form id="loanForm" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="first_name">First Name:</label>
                            <input type="text" id="first_name" name="first_name" required>
                        </div>
                        <div class="form-group">
                            <label for="last_name">Last Name:</label>
                            <input type="text" id="last_name" name="last_name" required>
                        </div>
                        <div class="form-group">
                            <label for="dob">Date of Birth:</label>
                            <input type="date" id="dob" name="dob" required>
                        </div>
                        <div class="form-group">
                            <label for="age">Age:</label>
                            <input type="number" id="age" name="age" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number:</label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                        <div class="form-group">
                            <label for="address">Address:</label>
                            <input type="text" id="address" name="address" required>
                        </div>
                        <div class="form-group">
                            <label for="occupation">Occupation:</label>
                            <input type="text" id="occupation" name="occupation" required>
                        </div>
                        <div class="form-group">
                            <label for="monthlyIncome">Monthly Income:</label>
                            <input type="number" id="monthlyIncome" name="monthlyIncome" required>
                        </div>
                        <div class="form-group">
                            <label for="loanAmount">Loan Amount:</label>
                            <input type="number" id="loanAmount" name="loanAmount" required>
                        </div>
                        <div class="form-group">
                            <label for="loanPurpose">Loan Purpose:</label>
                            <select id="loanPurpose" name="loanPurpose" required>
                                <option value="" disabled selected>Select Purpose</option>
                                <option value="Personal Loan">Personal Loan</option>
                                <option value="Business Loan">Business Loan</option>
                                <option value="Home Loan">Home Loan</option>
                                <option value="Education Loan">Education Loan</option>
                                <option value="Medical Loan">Medical Loan</option>
                                <option value="Vehicle Loan">Vehicle Loan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="aadharNumber">Aadhar Number:</label>
                            <input type="text" id="aadharNumber" name="aadharNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="aadharFile">Aadhar Upload:</label>
                            <input type="file" id="aadharFile" name="aadharFile" accept=".pdf" required>
                            <p class="form-note">Upload Aadhar (PDF only, max 5MB)</p>
                        </div>
                        <div class="form-group">
                            <label for="panNumber">PAN Number:</label>
                            <input type="text" id="panNumber" name="panNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="panFile">PAN Upload:</label>
                            <input type="file" id="panFile" name="panFile" accept=".pdf" required>
                            <p class="form-note">Upload PAN (PDF only, max 5MB)</p>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="$('#apply-loan').hide(); $('#dashboard').show();">Close</button>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- View Loan Status Section -->
            <section id="view-loan" class="content-section">
                <h2>View Loan Status</h2>
                <div class="card">
                    <table id="loanTable" class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Loan ID</th>
                                <th>Purpose</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="loanTableBody">
                            <!-- Loan data will be populated here -->
                        </tbody>
                    </table>
                    <p id="noLoansMessage" style="display: none;">No loan applications found.</p>
                </div>
            </section>

            <!-- View Products Section -->
            <section id="view-products" class="content-section">
                <h2>View Products</h2>
                <div class="card">
                    <table id="productsTable" class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Merchant</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Product data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Show/hide sections based on nav clicks
        $(document).ready(function() {
            $('.nav-link').click(function(e) {
                e.preventDefault();
                $('.nav-link').removeClass('active');
                $(this).addClass('active');
                $('.content-section').hide();
                const target = $(this).attr('href');
                $(target).show();

                // Fetch loan data when "View Loan" tab is clicked
                if (target === '#view-loan') {
                    fetchUserLoans();
                }
                // Fetch products when "View Products" tab is clicked
                if (target === '#view-products') {
                    fetchProducts();
                }
            });

            // Fetch loans on page load if "View Loan" is active
            if ($('.nav-link[href="#view-loan"]').hasClass('active')) {
                fetchUserLoans();
            }

            // Handle loan form submission
            $('#loanForm').submit(function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                $.ajax({
                    url: '{{ url_for("add_loan") }}',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        alert(response.message);
                        $('#loanForm')[0].reset();
                        $('#apply-loan').hide();
                        $('#dashboard').show();
                    },
                    error: function(xhr) {
                        alert('Error: ' + xhr.responseJSON.error);
                    }
                });
            });

            // Function to fetch user loans
            function fetchUserLoans() {
                $.ajax({
                    url: '{{ url_for("get_user_loans") }}',
                    type: 'GET',
                    success: function(response) {
                        const loans = response.loans;
                        const username = "{{ username | safe }}"; // Get username from template
                        const $tableBody = $('#loanTableBody');
                        $tableBody.empty();
                        if (loans.length === 0) {
                            $('#noLoansMessage').show();
                        } else {
                            $('#noLoansMessage').hide();
                            loans.forEach(function(loan) {
                                $tableBody.append(`
                                    <tr>
                                        <td>${username}</td>
                                        <td>${loan.loan_id}</td>
                                        <td>${loan.purpose}</td>
                                        <td>₹${loan.amount.toLocaleString('en-IN')}</td>
                                        <td>${loan.status}</td>
                                    </tr>
                                `);
                            });
                        }
                    },
                    error: function(xhr) {
                        $('#noLoansMessage').show();
                        $('#loanTableBody').empty();
                        alert('Error fetching loan data: ' + xhr.responseJSON.error);
                    }
                });
            }

            // Function to fetch all products
            function fetchProducts() {
                $.ajax({
                    url: '{{ url_for("get_all_products") }}',
                    type: 'GET',
                    success: function(response) {
                        const products = response.products;
                        const $tableBody = $('#productsTableBody');
                        $tableBody.empty();
                        if (products.length === 0) {
                            $tableBody.append('<tr><td colspan="4">No products available.</td></tr>');
                        } else {
                            products.forEach(function(product) {
                                $tableBody.append(`
                                    <tr>
                                        <td>${product.name}</td>
                                        <td>${product.description || 'N/A'}</td>
                                        <td>₹${product.price.toLocaleString('en-IN')}</td>
                                        <td>${product.merchant_name}</td>
                                    </tr>
                                `);
                            });
                        }
                    },
                    error: function(xhr) {
                        $('#productsTableBody').empty();
                        $('#productsTableBody').append('<tr><td colspan="4">Error fetching products.</td></tr>');
                    }
                });
            }
        });
    </script>
</body>
</html>