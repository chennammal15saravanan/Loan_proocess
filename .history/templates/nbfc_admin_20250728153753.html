<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NBFC Admin Dashboard</title>
  <link rel="icon" type="image/png" href="assets/images/favicon.png" sizes="16x16">
  <link rel="stylesheet" href="assets/css/remixicon.css">
  <link rel="stylesheet" href="assets/css/lib/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/lib/magnific-popup.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<aside class="sidebar">
  <button type="button" class="sidebar-close-btn">
    <iconify-icon icon="radix-icons:cross-2"></iconify-icon>
  </button>
  <div>
    <a href="nbfc_admin_dashboard.html" class="sidebar-logo">
      <img src="assets/images/logo.png" alt="site logo" class="light-logo">
      <img src="assets/images/logo-light.png" alt="site logo" class="dark-logo">
      <img src="assets/images/logo-icon.png" alt="site logo" class="logo-icon">
    </a>
  </div>
  
  <div class="sidebar-menu-area">
    <ul class="sidebar-menu" id="sidebar-menu">
      <li class="dropdown">
        <a href="javascript:void(0)">
          <iconify-icon icon="solar:home-smile-angle-outline" class="menu-icon"></iconify-icon>
          <span>NBFC Admin Dashboard</span>
        </a>
        <ul class="sidebar-submenu">
          <li>
            <a href="#welcome-dashboard"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Dashboard</a>
          </li>
          <li>
            <a href="#manage-loans"><i class="ri-circle-fill circle-icon text-warning-main w-auto"></i> Manage Loans</a>
          </li>
          <li>
            <a href="#accepted-loans"><i class="ri-circle-fill circle-icon text-success w-auto"></i> Accepted Loans</a>
          </li>
        </ul>
      </li>
    </ul>
  </div>
</aside>

<main class="dashboard-main">
  <div class="navbar-header">
    <div class="row align-items-center justify-content-between">
      <div class="col-auto">
        <div class="d-flex flex-wrap align-items-center gap-4">
          <button type="button" class="sidebar-toggle">
            <iconify-icon icon="heroicons:bars-3-solid" class="icon text-2xl non-active"></iconify-icon>
            <iconify-icon icon="iconoir:arrow-right" class="icon text-2xl active"></iconify-icon>
          </button>
          <button type="button" class="sidebar-mobile-toggle">
            <iconify-icon icon="heroicons:bars-3-solid" class="icon"></iconify-icon>
          </button>
          <form class="navbar-search">
            <input type="text" name="search" placeholder="Search">
            <iconify-icon icon="ion:search-outline" class="icon"></iconify-icon>
          </form>
        </div>
      </div>
      <div class="col-auto">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <button type="button" data-theme-toggle class="w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center"></button>
          <div class="dropdown">
            <button class="d-flex justify-content-center align-items-center rounded-circle" type="button" data-bs-toggle="dropdown">
              <img src="assets/images/user.png" alt="image" class="w-40-px h-40-px object-fit-cover rounded-circle">
            </button>
            <div class="dropdown-menu to-top dropdown-menu-sm">
              <div class="py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
                <div>
                  <h6 class="text-lg text-primary-light fw-semibold mb-2" id="userNameDropdown">{{ username }}</h6>
                  <span class="text-secondary-light fw-medium text-sm">NBFC Admin</span>
                </div>
                <button type="button" class="hover-text-danger">
                  <iconify-icon icon="radix-icons:cross-1" class="icon text-xl"></iconify-icon> 
                </button>
              </div>
              <ul class="to-top-list">
                <li>
                  <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-primary d-flex align-items-center gap-3" href="{{ url_for('dashboard') }}"> 
                    <iconify-icon icon="solar:user-linear" class="icon text-xl"></iconify-icon> Dashboard</a>
                </li>
                <li>
                  <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-danger d-flex align-items-center gap-3" href="{{ url_for('logout') }}"> 
                    <iconify-icon icon="lucide:power" class="icon text-xl"></iconify-icon> Log Out</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-main-body" id="content-section">
    <!-- Welcome Dashboard Section -->
    <div id="welcome-dashboard" class="section">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
        <h6 class="fw-semibold mb-0">Welcome Dashboard</h6>
        <ul class="d-flex align-items-center gap-2">
          <li class="fw-medium">Hello, <span id="userNameWelcome">{{ username }}</span>!</li>
        </ul>
      </div>
      <div class="row gy-4">
        <div class="col-lg-12">
          <div class="card mt-24">
            <div class="card-body p-24">
              <!-- Blank content for welcome dashboard -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="d-flex flex-wrap align-items-center justify-content-end gap-2">
          <a href="javascript:void(0)" class="btn btn-sm btn-warning radius-8 d-inline-flex align-items-center gap-1">
            <iconify-icon icon="solar:download-linear" class="text-xl"></iconify-icon>
            Download
          </a>
          <a href="javascript:void(0)" class="btn btn-sm btn-success radius-8 d-inline-flex align-items-center gap-1">
            <iconify-icon icon="uil:edit" class="text-xl"></iconify-icon>
            Edit
          </a>
          <button type="button" class="btn btn-sm btn-danger radius-8 d-inline-flex align-items-center gap-1" onclick="printInvoice()">
            <iconify-icon icon="basil:printer-outline" class="text-xl"></iconify-icon>
            Print
          </button>
        </div>
      </div>
    </div>

    <!-- Manage Loans Section -->
    <div id="manage-loans" class="section" style="display: none;">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
        <h6 class="fw-semibold mb-0">Manage Loan Applications</h6>
        <div class="d-flex gap-2">
          <input type="text" class="form-control" id="loanSearch" placeholder="Search by ID or Amount">
          <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              Status
            </button>
            <ul class="dropdown-menu" aria-labelledby="statusDropdown">
              <li><a class="dropdown-item" href="#" data-status="all">All</a></li>
              <li><a class="dropdown-item" href="#" data-status="pending">Pending</a></li>
              <li><a class="dropdown-item" href="#" data-status="accepted">Accepted</a></li>
              <li><a class="dropdown-item" href="#" data-status="rejected">Rejected</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="row gy-4">
        <div class="col-lg-12">
          <div class="card mt-24">
            <div class="card-body p-24">
              <div id="loanRequests" class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Address</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="loanTableBody">
                    <!-- Loan data will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Accepted Loans Section -->
    <div id="accepted-loans" class="section" style="display: none;">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
        <h6 class="fw-semibold mb-0">Accepted Loans</h6>
        <div class="d-flex gap-2">
          <input type="text" class="form-control" id="acceptedLoanSearch" placeholder="Search by ID or Amount">
        </div>
      </div>
      <div class="row gy-4">
        <div class="col-lg-12">
          <div class="card mt-24">
            <div class="card-body p-24">
              <div id="acceptedLoanRequests" class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Address</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="acceptedLoanTableBody">
                    <!-- Accepted loan data will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmLoanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Manager Loan Approval Confirmation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Loan Details:</strong></p>
          <ul id="loanDetailsList">
            <!-- Populated dynamically -->
          </ul>
          <p><strong>Terms and Conditions:</strong></p>
          <ul>
            <li>All submitted documents have been verified and found satisfactory.</li>
            <li>Repayment must be made on or before the due date.</li>
            <li>Late payments attract a penalty and may lead to legal action.</li>
            <li>The loan must only be used for the stated purpose.</li>
            <li>The lender reserves the right to cancel the loan on misuse or breach.</li>
            <li>Disputes are subject to the jurisdiction of Chennai courts.</li>
          </ul>
          <hr>
          <p class="mb-2"><strong>Manager Confirmation:</strong></p>
          <p>To approve the loan, type <code>confirm loan</code> and enter your name below.</p>
          <div class="mb-3">
            <label for="confirmationText" class="form-label">Type "confirm loan":</label>
            <input type="text" id="confirmationText" class="form-control" placeholder="Type here..." required>
          </div>
          <div>
            <label for="managerName" class="form-label">Manager Name:</label>
            <input type="text" class="form-control" id="managerName" placeholder="Enter your full name" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="confirmLoanStatus()">Confirm</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Success</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body"></div>
    </div>
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-danger text-white">
        <strong class="me-auto">Error</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body"></div>
    </div>
  </div>

  <script src="assets/js/lib/jquery-3.7.1.min.js"></script>
  <script src="assets/js/lib/bootstrap.bundle.min.js"></script>
  <script src="assets/js/lib/iconify-icon.min.js"></script>
  <script src="assets/js/lib/magnific-popup.min.js"></script>
  <script src="assets/js/app.js"></script>

  <script>
    let currentLoanId = null;

    document.addEventListener('DOMContentLoaded', () => {
      // Show the welcome dashboard by default
      document.getElementById('welcome-dashboard').style.display = 'block';

      // Handle sidebar navigation
      document.querySelectorAll('.sidebar-submenu a').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const href = link.getAttribute('href').substring(1);
          document.querySelectorAll('.section').forEach(section => {
            section.style.display = 'none';
          });
          const targetSection = document.getElementById(href);
          if (targetSection) {
            targetSection.style.display = 'block';
            if (href === 'manage-loans') {
              fetchLoanApplications();
            } else if (href === 'accepted-loans') {
              fetchAcceptedLoans();
            }
          } else {
            console.error(`Section with ID ${href} not found`);
          }
        });
      });

      // Search filter for loan applications
      const loanSearchInput = document.getElementById('loanSearch');
      if (loanSearchInput) {
        loanSearchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const rows = document.querySelectorAll('#loanTableBody tr');
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
          });
        });
      } else {
        console.error('Loan search input not found');
      }

      // Search filter for accepted loans
      const acceptedLoanSearchInput = document.getElementById('acceptedLoanSearch');
      if (acceptedLoanSearchInput) {
        acceptedLoanSearchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const rows = document.querySelectorAll('#acceptedLoanTableBody tr');
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
          });
        });
      } else {
        console.error('Accepted loan search input not found');
      }

      // Status filter for loan applications
      document.querySelectorAll('#statusDropdown .dropdown-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const status = item.getAttribute('data-status');
          const rows = document.querySelectorAll('#loanTableBody tr');
          rows.forEach(row => {
            const rowStatus = row.querySelector('td:nth-child(4) span').textContent.toLowerCase();
            row.style.display = status === 'all' || rowStatus === status ? '' : 'none';
          });
          const statusDropdown = document.getElementById('statusDropdown');
          if (statusDropdown) {
            statusDropdown.textContent = status === 'all' ? 'Status' : status.charAt(0).toUpperCase() + status.slice(1);
          }
        });
      });
    });

    function setCurrentLoanId(loanId) {
      currentLoanId = loanId;
      console.log("Current Loan ID set to:", currentLoanId);
    }

    function showToast(message, isError = false) {
      const toastId = isError ? 'errorToast' : 'successToast';
      const toast = new bootstrap.Toast(document.getElementById(toastId));
      document.querySelector(`#${toastId} .toast-body`).textContent = message;
      toast.show();
    }

    function confirmLoanStatus() {
      const confirmationText = document.getElementById("confirmationText").value.trim();
      const managerName = document.getElementById("managerName").value.trim();

      if (confirmationText.toLowerCase() !== "confirm loan") {
        showToast("Please type 'confirm loan' to proceed.", true);
        return;
      }

      if (!managerName) {
        showToast("Please enter your name.", true);
        return;
      }

      if (!currentLoanId) {
        showToast("Loan ID is missing. Please refresh and try again.", true);
        return;
      }

      fetch('/update-loan-status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          loan_id: currentLoanId,
          status: 'accepted',
          manager_name: managerName
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.message) {
          showToast(data.message);
          const modal = bootstrap.Modal.getInstance(document.getElementById('confirmLoanModal'));
          if (modal) modal.hide();
          fetchLoanApplications();
          console.log("Loan applications table refreshed after status update.");
        } else {
          showToast(data.error || "An error occurred.", true);
        }
      })
      .catch(err => {
        console.error("Error updating loan status:", err);
        showToast("Failed to update loan status due to a network or server error.", true);
      });
    }

    function fetchLoanApplications() {
      const loanTableBody = document.getElementById('loanTableBody');
      if (!loanTableBody) {
        console.error('Loan table body not found');
        return;
      }

      fetch('/get-loan-applications?_=' + new Date().getTime())
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Fetched loan applications:", data);
          if (data.error) {
            throw new Error(data.error);
          }
          loanTableBody.innerHTML = '';
          if (!data.loans || data.loans.length === 0) {
            loanTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No loan applications found.</td></tr>';
            return;
          }
          data.loans.forEach(loan => {
            const row = document.createElement('tr');
            row.dataset.id = loan.request_id;
            const statusClass = loan.status.toLowerCase() === 'pending' ? 'bg-warning' :
                              loan.status.toLowerCase() === 'accepted' ? 'bg-success' : 'bg-danger';
            row.innerHTML = `
              <td>${loan.first_name}</td>
              <td>${loan.address || 'N/A'}</td>
              <td>₹${parseFloat(loan.amount || 0).toFixed(2)}</td>
              <td><span class="badge ${statusClass}">${loan.status}</span></td>
              <td>
                <button class="btn btn-primary btn-sm viewLoan" data-id="${loan.request_id}">View</button>
              </td>
            `;
            loanTableBody.appendChild(row);

            row.querySelector('.viewLoan').addEventListener('click', () => viewLoanDetails(loan.request_id));
          });
        })
        .catch(error => {
          console.error('Error fetching loans:', error);
          loanTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Error loading loan applications. Please try again later.</td></tr>';
        });
    }

    function fetchAcceptedLoans() {
      const acceptedLoanTableBody = document.getElementById('acceptedLoanTableBody');
      if (!acceptedLoanTableBody) {
        console.error('Accepted loan table body not found');
        return;
      }

      fetch('/get-loan-applications?status=accepted&_=' + new Date().getTime())
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Fetched accepted loans:", data);
          if (data.error) {
            throw new Error(data.error);
          }
          acceptedLoanTableBody.innerHTML = '';
          if (!data.loans || data.loans.length === 0) {
            acceptedLoanTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No accepted loans found.</td></tr>';
            return;
          }
          data.loans.forEach(loan => {
            const row = document.createElement('tr');
            row.dataset.id = loan.request_id;
            row.innerHTML = `
              <td>${loan.first_name}</td>
              <td>${loan.address || 'N/A'}</td>
              <td>₹${parseFloat(loan.amount || 0).toFixed(2)}</td>
              <td><span class="badge bg-success">${loan.status}</span></td>
              <td>
                <button class="btn btn-primary btn-sm viewLoan" data-id="${loan.request_id}">View</button>
              </td>
            `;
            acceptedLoanTableBody.appendChild(row);

            row.querySelector('.viewLoan').addEventListener('click', () => viewLoanDetails(loan.request_id));
          });
        })
        .catch(error => {
          console.error('Error fetching accepted loans:', error);
          acceptedLoanTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Error loading accepted loans. Please try again later.</td></tr>';
        });
    }

    function viewLoanDetails(loanId) {
      fetch(`/get-loan-details/${loanId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            throw new Error(data.error);
          }
          const loan = data.loan;
          // Populate confirmation modal with loan details
          const modalLoanDetails = document.querySelector('#confirmLoanModal #loanDetailsList');
          modalLoanDetails.innerHTML = `
            <li><strong>Customer Name:</strong> ${loan.first_name} ${loan.last_name || ''}</li>
            <li><strong>Loan Amount:</strong> ₹${parseFloat(loan.loan_amount || 0).toFixed(2)}</li>
            <li><strong>Loan Purpose:</strong> ${loan.loan_purpose || 'N/A'}</li>
            <li><strong>Monthly Income:</strong> ₹${parseFloat(loan.monthly_income || 0).toFixed(2)}</li>
            <li><strong>Application Date:</strong> ${loan.created_at || 'N/A'}</li>
          `;
          // Build loan details modal content
          let modalContent = `
            <h6 class="fw-semibold mb-3">Borrower Details</h6>
            <p><strong>First Name:</strong> ${loan.first_name || 'N/A'}</p>
            <p><strong>Last Name:</strong> ${loan.last_name || 'N/A'}</p>
            <p><strong>Date of Birth:</strong> ${loan.dob || 'N/A'}</p>
            <p><strong>Age:</strong> ${loan.age || 'N/A'}</p>
            <p><strong>Phone:</strong> ${loan.phone || 'N/A'}</p>
            <p><strong>Address:</strong> ${loan.address || 'N/A'}</p>
            <p><strong>Occupation:</strong> ${loan.occupation || 'N/A'}</p>
            <p><strong>Monthly Income:</strong> ₹${parseFloat(loan.monthly_income || 0).toFixed(2)}</p>
            <p><strong>Loan Amount:</strong> ₹${parseFloat(loan.loan_amount || 0).toFixed(2)}</p>
            <p><strong>Loan Purpose:</strong> ${loan.loan_purpose || 'N/A'}</p>
            <p><strong>Aadhaar Number:</strong> ${loan.aadhaar_number || 'N/A'}</p>
            <p><strong>PAN Number:</strong> ${loan.pan_number || 'N/A'}</p>
            <p><strong>Aadhaar Document:</strong> <a href="${loan.aadhaar_url || '#'}" class="text-primary text-decoration-underline" target="_blank">${loan.aadhaar_url ? 'View Document' : 'N/A'}</a></p>
            <p><strong>PAN Document:</strong> <a href="${loan.pan_url || '#'}" class="text-primary text-decoration-underline" target="_blank">${loan.pan_url ? 'View Document' : 'N/A'}</a></p>
            <p><strong>Status:</strong> ${loan.status || 'N/A'}</p>
            <p><strong>Application Date:</strong> ${loan.created_at || 'N/A'}</p>
            <p><strong>Review Status:</strong> ${loan.review_status || 'N/A'}</p>
            <h6 class="fw-semibold mt-4 mb-3">Merchant Details</h6>
            <p><strong>Referred By:</strong> ${loan.referred_by || 'N/A'}</p>
          `;
          Object.keys(loan).forEach(key => {
            if (!['request_id', 'first_name', 'last_name', 'dob', 'age', 'phone', 'address', 'occupation', 'monthly_income', 'loan_amount', 'loan_purpose', 'aadhaar_number', 'pan_number', 'aadhaar_url', 'pan_url', 'status', 'created_at', 'review_status', 'referred_by'].includes(key)) {
              modalContent += `<p><strong>${key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}:</strong> ${loan[key] || 'N/A'}</p>`;
            }
          });
          const acceptButton = loan.status.toLowerCase() === 'pending' ? 
            `<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmLoanModal" onclick="setCurrentLoanId('${loanId}')">Accept</button>` : 
            `<button type="button" class="btn btn-success" disabled>Accept</button>`;
          const modal = document.createElement('div');
          modal.className = 'modal fade';
          modal.id = 'loanDetailsModal';
          modal.innerHTML = `
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Loan Application Details</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  ${modalContent}
                </div>
                <div class="modal-footer">
                  ${acceptButton}
                  <button type="button" class="btn btn-danger" onclick="handleLoanDecision('${loanId}', 'rejected')">Reject</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          const bsModal = new bootstrap.Modal(modal);
          bsModal.show();
          modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
          });
        })
        .catch(error => {
          console.error('Error fetching loan details:', error);
          showToast(`Error fetching loan details: ${error.message}. Please try again.`, true);
        });
    }

    function handleLoanDecision(loanId, status) {
      fetch('/update-loan-status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          loan_id: loanId,
          status: status
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.message) {
          showToast(data.message);
          const modal = bootstrap.Modal.getInstance(document.getElementById('loanDetailsModal'));
          if (modal) modal.hide();
          fetchLoanApplications();
        } else {
          showToast(data.error || "An error occurred.", true);
        }
      })
      .catch(err => {
        console.error("Error updating loan status:", err);
        showToast("Failed to update loan status due to a network or server error.", true);
      });
    }

  function printInvoice() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Determine which section is active
  const manageLoansSection = document.getElementById('manage-loans');
  const acceptedLoansSection = document.getElementById('accepted-loans');
  let tableBodyId = '';
  let title = '';

  if (manageLoansSection.style.display === 'block') {
    tableBodyId = 'loanTableBody';
    title = 'Loan Applications Report';
  } else if (acceptedLoansSection.style.display === 'block') {
    tableBodyId = 'acceptedLoanTableBody';
    title = 'Accepted Loans Report';
  } else {
    showToast('No table data available to print. Please navigate to Manage Loans or Accepted Loans.', true);
    return;
  }

  const tableBody = document.getElementById(tableBodyId);
  if (!tableBody || tableBody.querySelectorAll('tr').length === 0) {
    showToast('No data available to print.', true);
    return;
  }

  // Add title to the PDF
  doc.setFontSize(18);
  doc.text(title, 14, 20);

  // Prepare table data
  const tableData = [];
  const rows = tableBody.querySelectorAll('tr');
  rows.forEach(row => {
    const rowData = [];
    const cells = row.querySelectorAll('td');
    if (cells.length >= 4) { // Ensure there are enough cells
      rowData.push(cells[0].textContent); // Name
      rowData.push(cells[1].textContent); // Address
      rowData.push(cells[2].textContent); // Amount
      rowData.push(cells[3].querySelector('span').textContent); // Status
    }
    if (rowData.length > 0) {
      tableData.push(rowData);
    }
  });

  if (tableData.length === 0) {
    showToast('No valid data to print.', true);
    return;
  }

  // Generate table in PDF
  doc.autoTable({
    head: [['Name', 'Address', 'Amount', 'Status']],
    body: tableData,
    startY: 30,
    theme: 'grid',
    styles: { fontSize: 10, cellPadding: 2 },
    headStyles: { fillColor: [41, 128, 185], textColor: [255, 255, 255] },
    alternateRowStyles: { fillColor: [240, 240, 240] },
    margin: { top: 30 }
  });

  // Add footer with date
  const date = new Date().toLocaleDateString();
  doc.setFontSize(10);
  doc.text(`Generated on: ${date}`, 14, doc.internal.pageSize.height - 10);

  // Save the PDF
  doc.save(`${title.replace(' ', '_')}_${date}.pdf`);
}
  </script>
</body>
</html>